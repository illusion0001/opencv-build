name: Build OpenCV with QT+OGL Support for Windows

on: push

concurrency:
  group: ${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Set OpenCV Version
        run: echo opencv_ver="4.7.0" >> $env:GITHUB_ENV

      - name: Cache OpenCV
        uses: actions/cache@v3
        id: cache0
        with:
          path: C:\downloads\opencv-${{ env.opencv_ver }}
          key: ${{ runner.os }}OpenCV-BuildCache

      - name: Download OpenCV
        run: |
          mkdir C:\downloads
          $opencv_ver1=$env:opencv_ver
          curl -fL https://github.com/opencv/opencv/archive/${opencv_ver1}.zip -o C:\downloads\opencv-${opencv_ver1}.zip
          curl -fL https://github.com/opencv/opencv_contrib/archive/$opencv_ver1.zip -o C:\downloads\opencv_contrib-${opencv_ver1}.zip
          7z -r x C:\downloads\opencv-${opencv_ver1}.zip -oc:\downloads\
          7z -r x C:\downloads\opencv_contrib-${opencv_ver1}.zip -oc:\downloads\
          echo OpenCV_DIR="C:\downloads\opencv-${opencv_ver1}" >> $env:GITHUB_ENV
          Remove-Item -Force C:\downloads\opencv-${opencv_ver1}.zip
          Remove-Item -Force C:\downloads\opencv_contrib-${opencv_ver1}.zip
          ls -R && false
          # cmake -D OPENCV_EXTRA_MODULES_PATH=~/opencv_contrib-4.X.X/modules

      - name: Install CUDA SDK
        uses: Jimver/cuda-toolkit@v0.2.8
        with:
          cuda: '11.7.0'

      - name: Verify if CUDA is installed
        run: |
          echo "Installed cuda version is: ${{steps.cuda-toolkit.outputs.cuda}}"
          echo "Cuda install location: ${{steps.cuda-toolkit.outputs.CUDA_PATH}}"
          nvcc -V

      - name: Compile OpenCV
        if: steps.cache0.outputs.cache-hit != 'true'
        run: |
          mkdir $env:OpenCV_DIR\build_64
          cmake -G "Visual Studio 17 2022" -S ${env:OpenCV_DIR}\ -B ${env:OpenCV_DIR}\build_64\ `
          -DBUILD_opencv_core=ON `
          -DBUILD_opencv_features2d=ON `
          -DBUILD_opencv_calib3d=ON `
          -DBUILD_opencv_flann=ON `
          -DBUILD_opencv_imgproc=ON `
          -DBUILD_opencv_video=ON `
          -DBUILD_opencv_videoio=ON `
          -DBUILD_opencv_videoio=ON `
          -DBUILD_opencv_highgui=ON `
          -DBUILD_opencv_world=ON `
          -DWITH_OPENCL=ON `
          -DWITH_OPENCL_D3D11_NV=ON `
          -DWITH_OPENGL=ON `
          -DWITH_DIRECTX=ON `
          -DWITH_CUDA=ON
          cmake --build ${env:OpenCV_DIR}\build_64\

      - name: Package Prebuilt OpenCV
        run: |
          $opencv_ver1=$env:opencv_ver
          mkdir libbin
          cd c:\downloads
          7z a ${env:GITHUB_WORKSPACE}\libbin\opencv-${opencv_ver1}.7z -m0=LZMA2 -mx9

      - name: Upload Prebuilt OpenCV binaries
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        if: github.event_name != 'pull_request'
        run: gh release create $env:opencv_ver libbin\opencv-${env:opencv_ver}.7z --target $env:GITHUB_SHA -t "OpenCV ${env:opencv_ver} with QT+OGL Support for Windows"

